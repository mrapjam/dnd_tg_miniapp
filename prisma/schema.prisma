generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Game {
  id                Int        @id @default(autoincrement())
  code              String     @unique
  gmTgId            String
  status            String     @default("lobby") // lobby | started
  currentLocation   Location?  @relation(fields: [currentLocationId], references: [id])
  currentLocationId Int?

  createdAt         DateTime   @default(now())
  players           Player[]
  messages          Message[]
  locations         Location[]
  items             Item[]
  rolls             Roll[]
}

model Player {
  id        Int      @id @default(autoincrement())
  game      Game     @relation(fields: [gameId], references: [id])
  gameId    Int
  userTgId  String
  name      String
  hp        Int      @default(10)
  gold      Int      @default(0)
  skills    Json     @default("[]")
  photo     String?  // dataURL или ссылка
  note      String?  // описание персонажа (заполняет ГМ)

  createdAt DateTime @default(now())

  items     Item[]
  rolls     Roll[]

  @@unique([gameId, userTgId])
}

model Message {
  id        Int      @id @default(autoincrement())
  game      Game     @relation(fields: [gameId], references: [id])
  gameId    Int
  userTgId  String
  name      String
  text      String
  at        DateTime @default(now())
}

model Location {
  id          Int      @id @default(autoincrement())
  game        Game     @relation(fields: [gameId], references: [id])
  gameId      Int
  title       String
  description String   @default("")
  image       String?  // dataURL или ссылка
  createdAt   DateTime @default(now())

  items       Item[]
  gamesWhereCurrent Game[]
}

model Item {
  id             Int      @id @default(autoincrement())
  game           Game     @relation(fields: [gameId], references: [id])
  gameId         Int
  owner          Player?  @relation(fields: [ownerPlayerId], references: [id])
  ownerPlayerId  Int?
  name           String
  qty            Int      @default(1)
  note           String   @default("")
  type           String   @default("misc")
  location       Location? @relation(fields: [locationId], references: [id])
  locationId     Int?
  createdAt      DateTime @default(now())
}

model Roll {
  id        Int      @id @default(autoincrement())
  game      Game     @relation(fields: [gameId], references: [id])
  gameId    Int
  player    Player   @relation(fields: [playerId], references: [id])
  playerId  Int
  die       Int
  result    Int
  at        DateTime @default(now())
}
