// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Game {
  code          String   @id
  gmId          String
  started       Boolean  @default(false)
  createdAt     DateTime @default(now())
  lastActivity  DateTime @default(now())
  expiresAt     DateTime

  // связи
  players       Player[]
  items         Item[]
  messages      Message[]
  locations     Location[]
  location      Location? @relation("CurrentLocation", fields: [locationId], references: [id])
  locationId    String?

  @@index([expiresAt])
}

model Player {
  id        String   @id @default(cuid())
  gameCode  String
  userId    String
  name      String
  avatar    String?
  hp        Int      @default(10)
  gold      Int      @default(0)
  createdAt DateTime @default(now())

  game      Game     @relation(fields: [gameCode], references: [code])
  items     Item[]

  @@unique([gameCode, userId])
}

enum ItemType {
  item
  gold
}

model Item {
  id        String   @id @default(cuid())
  gameCode  String
  name      String
  type      ItemType @default(item)
  amount    Int?
  onFloor   Boolean  @default(true)
  ownerId   String?
  createdAt DateTime @default(now())

  game      Game     @relation(fields: [gameCode], references: [code])
  owner     Player?  @relation(fields: [ownerId], references: [id])

  @@index([gameCode, onFloor, createdAt])
}

model Message {
  id        String   @id @default(cuid())
  gameCode  String
  userId    String
  name      String
  text      String
  createdAt DateTime @default(now())

  game      Game     @relation(fields: [gameCode], references: [code])

  @@index([gameCode, createdAt])
}

model Location {
  id          String   @id @default(cuid())
  gameCode    String
  title       String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  game        Game     @relation(fields: [gameCode], references: [code])
  currentIn   Game[]   @relation("CurrentLocation")

  @@index([gameCode])
}
