<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>DND MiniApp</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    nav { background:#222; color:#fff; padding:10px; }
    nav button { margin-right:5px; }
    section { padding:10px; }
    .gm { background:#fee; }
    input,button,select { margin:3px; }
    .block { margin:10px 0; padding:5px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <nav>
    <button onclick="show('lobby')">–õ–æ–±–±–∏</button>
    <button onclick="show('chat')">–ß–∞—Ç</button>
    <button onclick="show('map')">–ö–∞—Ä—Ç–∞</button>
    <button onclick="show('gm')">–ì–ú</button>
  </nav>
  <section id="lobby"></section>
  <section id="chat" style="display:none"></section>
  <section id="map" style="display:none"></section>
  <section id="gm" class="gm" style="display:none"></section>

<script>
let code = new URLSearchParams(location.search).get("startapp");
let me, game;

async function load() {
  const res = await fetch("/api/lobby/"+code);
  game = await res.json();
  me = game.players.find(p=>p.tgId===window.Telegram?.WebApp?.initDataUnsafe?.user?.id?.toString());
  renderLobby();
  renderChat();
  renderMap();
  renderGM();
}

function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

function renderLobby(){
  lobby.innerHTML = `<h2>${game.title}</h2>
  ${game.players.map(p=>p.name+" HP:"+p.hp+" üí∞"+p.gold+(p.isGM?" (–ì–ú)":"")+(p.location?" üìç "+p.location.name:"")).join("<br>")}`;
}

function renderChat(){
  chat.innerHTML = game.messages.map(m=>m.text).join("<br>");
}

function renderMap(){
  map.innerHTML = `<h2>–ö–∞—Ä—Ç–∞</h2>
  ${game.locations.map(l=>`
    <div class="block">
      <b>${l.name}</b><br>${l.descr||""}<br>
      <i>–ò–≥—Ä–æ–∫–∏:</i> ${game.players.filter(p=>p.locationId===l.id).map(p=>p.name).join(", ")||"‚Äî"}<br>
      <i>–ü—Ä–µ–¥–º–µ—Ç—ã:</i> ${game.items.filter(i=>i.locationId===l.id).map(i=>i.name+" x"+i.qty).join(", ")||"‚Äî"}
    </div>
  `).join("")}`;
}

function renderGM(){
  if(!me?.isGM) { gm.style.display="none"; return; }
  gm.style.display="block";
  gm.innerHTML = `<h2>GM –ü–∞–Ω–µ–ª—å</h2>

  <div class="block">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π</h3>
    ${!game.started 
      ? `<button onclick="startGame()">üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>` 
      : `<i>–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞</i>`}
  </div>

  <div class="block"><h3>–ò–≥—Ä–æ–∫–∏</h3>
  ${game.players.map(p=>`
    ${p.name} (HP:${p.hp} Gold:${p.gold})
    <button onclick="upd(${p.id},{hp:${p.hp+1}})">+HP</button>
    <button onclick="upd(${p.id},{hp:${p.hp-1}})">-HP</button>
    <button onclick="upd(${p.id},{gold:${p.gold+1}})">+Gold</button>
    <button onclick="upd(${p.id},{gold:${p.gold-1}})">-Gold</button>
    <select onchange="movePlayer(${p.id},this.value)">
      <option value="">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</option>
      ${game.locations.map(l=>`<option value="${l.id}">${l.name}</option>`).join("")}
    </select>
  `).join("<br>")}
  <br><br>
  <input id="newPlayerName" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞/NPC">
  <button onclick="newPlayer()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <div class="block"><h3>–õ–æ–∫–∞—Ü–∏–∏</h3>
  ${game.locations.map(l=>l.name).join("<br>")}
  <br><br>
  <input id="locName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
  <input id="locDescr" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
  <button onclick="newLocation()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <div class="block"><h3>–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
  ${game.items.map(i=>i.name+" (x"+i.qty+")").join("<br>")}
  <br><br>
  <input id="itemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
  <input id="itemQty" type="number" value="1" style="width:50px">
  <select id="itemOwner">
    <option value="">–ù–∏–∫–æ–º—É</option>
    ${game.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join("")}
  </select>
  <select id="itemLoc">
    <option value="">–ù–µ—Ç –ª–æ–∫–∞—Ü–∏–∏</option>
    ${game.locations.map(l=>`<option value="${l.id}">${l.name}</option>`).join("")}
  </select>
  <button onclick="newItem()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <div class="block"><h3>–ö—É–±–∏–∫–∏</h3>
  <button onclick="roll(6)">üé≤ D6</button>
  <button onclick="roll(20)">üé≤ D20</button>
  <input id="customDie" type="number" placeholder="D?" style="width:60px">
  <button onclick="roll(document.getElementById('customDie').value)">–ë—Ä–æ—Å–∏—Ç—å</button>
  <div id="rolls"></div>
  </div>
  `;
}

// === API –≤—ã–∑–æ–≤—ã ===
async function upd(id,data){
  await fetch("/api/player/"+id,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  load();
}
async function newPlayer(){
  const name = document.getElementById("newPlayerName").value;
  if(!name) return;
  await fetch("/api/player/0",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({
    gameId: game.id, tgId: "npc_"+Date.now(), name
  })});
  load();
}
async function newLocation(){
  const name=document.getElementById("locName").value;
  const descr=document.getElementById("locDescr").value;
  await fetch("/api/location",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({gameId:game.id,name,descr})});
  load();
}
async function newItem(){
  const name=document.getElementById("itemName").).value;
  const qty=parseInt(document.getElementById("itemQty").value)||1;
  const owner=document.getElementById("itemOwner").value||null;
  const loc=document.getElementById("itemLoc").value||null;
  await fetch("/api/item",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({
    gameId:game.id,name,qty,ownerId:owner?parseInt(owner):null,locationId:loc?parseInt(loc):null
  })});
  load();
}
async function movePlayer(id,locId){
  if(!locId) return;
  await fetch("/api/player/"+id,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({locationId:parseInt(locId)})});
  load();
}
async function roll(die){
  if(!die) return;
  const res=await fetch("/api/roll",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({gameId:game.id,playerId:me?.id||null,die:parseInt(die)})});
  const r=await res.json();
  document.getElementById("rolls").innerHTML+="<div>"+(me?.name||"GM")+" –±—Ä–æ—Å–∏–ª D"+die+" ‚Üí "+r.result+"</div>";
}
async function startGame(){
  if(game.locations.length===0){ alert("–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ª–æ–∫–∞—Ü–∏—é!"); return; }
  const firstLoc = game.locations[0].id;
  await fetch("/api/game/"+game.id+"/start",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({locationId:firstLoc})});
  load();
}
load();
</script>
</body>
</html>
