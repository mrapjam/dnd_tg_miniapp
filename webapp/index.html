<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DnD Mini App</title>
<style>
  :root { --bg:#0f1115; --panel:#171a21; --muted:#8a94a7; --acc:#4cc3ff; --ok:#46d37a; --bad:#ff5c7c; }
  html,body { margin:0; padding:0; background:var(--bg); color:#e6edf3; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
  .wrap { max-width:980px; margin:0 auto; padding:16px; }
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .col{background:var(--panel); border:1px solid #222733; border-radius:12px; padding:14px; flex:1 1 320px; min-width:320px;}
  .top {display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .badge {background:#222733; border:1px solid #2a3040; border-radius:10px; padding:6px 10px; font-size:12px; color:#c7cfdb}
  h2{margin:0 0 8px 0; font-size:18px}
  .btn{background:#202534; border:1px solid #2a3040; color:#dfe6f2; padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn:hover{border-color:#3b4258}
  .btn.big{font-size:18px; padding:14px 18px}
  .btn.primary{background:#243047; border-color:#304566}
  .btn.good{background:#1f3b2d; border-color:#2b6a4c}
  .btn.bad{background:#42232b; border-color:#7a3a48}
  .pill{display:inline-block; padding:8px 12px; border:1px dashed #394255; border-radius:10px; color:#d0d7e3}
  .field{display:flex; gap:8px; margin:8px 0}
  input,textarea,select{background:#0e121b; color:#dfe6f2; border:1px solid #2a3040; border-radius:10px; padding:10px; flex:1}
  textarea{min-height:70px}
  .players .p{border:1px solid #2a3040; border-radius:10px; padding:8px; margin:8px 0}
  .small{font-size:12px; color:#aab2c3}
  .chat{max-height:260px; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:8px; background:#101521}
  .msg{margin:4px 0}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .avatar{width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #2a3040}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:8px}
  .dicebar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  .hidden{display:none !important}
  .divider{height:1px;background:#222733;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div id="you" class="badge">‚Äî</div>
    <div id="code" class="badge">–ö–æ–¥: ‚Äî</div>
  </div>

  <!-- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏–≥—Ä–æ–∫–∞ -->
  <div id="joinPanel" class="col">
    <h2>–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</h2>
    <div class="small">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä. –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–∞—Ç –∏ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
    <div class="field"><input id="nameInput" placeholder="–í–∞—à–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" /></div>

    <div class="small" style="margin-top:6px">–ê–≤–∞—Ç–∞—Ä:</div>
    <div class="field">
      <input id="photoFile" type="file" accept="image/*" />
    </div>
    <div class="small">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:</div>
    <div id="presetAvatars" class="flex"></div>
    <div class="field">
      <button class="btn primary" id="joinBtn">–í–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞ -->
  <div id="gmPanel" class="col hidden">
    <h2>–ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h2>
    <div class="small">–ò–≥—Ä–æ–∫–∏:</div>
    <div id="playersList" class="players"></div>

    <div class="divider"></div>

    <div class="small">–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç / –ù–∞ –ø–æ–ª</div>
    <div class="field"><input id="gmItemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" /></div>
    <div class="field">
      <select id="gmGiveTo"></select>
      <input id="gmQty" type="number" min="1" value="1" style="max-width:120px">
    </div>
    <div class="field">
      <button class="btn" id="gmGiveBtn">‚ûï –í—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
      <button class="btn" id="gmDropBtn">–ù–∞ –ø–æ–ª</button>
    </div>

    <div class="divider"></div>

    <div class="small">–ó–æ–ª–æ—Ç–æ</div>
    <div class="field">
      <input id="gmGoldQty" type="number" min="1" value="1" style="max-width:120px">
      <button class="btn" id="gmGoldDropBtn">–ë—Ä–æ—Å–∏—Ç—å –∑–æ–ª–æ—Ç–æ –Ω–∞ –ø–æ–ª</button>
    </div>

    <div class="divider"></div>

    <div class="small">–õ–æ–∫–∞—Ü–∏–∏</div>
    <div class="field"><input id="locTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏"></div>
    <div class="field"><textarea id="locDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏"></textarea></div>
    <div class="small">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é):</div>
    <div class="field"><input id="locImg" type="file" accept="image/*" /></div>
    <div class="field">
      <button class="btn" id="addLocBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
      <button class="btn primary" id="startGameBtn">‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
    <div class="small">–°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π:</div>
    <div id="locList" class="grid"></div>
  </div>

  <!-- –ò–≥—Ä–æ–∫ (–ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–æ—Å–∫–∏ –Ω–∞–≤–µ—Ä—Ö—É) -->
  <div id="playerPanel" class="col hidden">
    <div id="diceBar" class="dicebar hidden">
      <button class="btn big" data-d="6">üé≤ d6</button>
      <button class="btn big" data-d="8">üé≤ d8</button>
      <button class="btn big" data-d="20">üé≤ d20</button>
    </div>

    <div id="locBlock" class="hidden">
      <h2>–õ–æ–∫–∞—Ü–∏—è</h2>
      <div id="locName" class="pill">‚Äî</div>
      <div class="field"><img id="locImage" class="hidden" style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #2a3040"></div>
      <div id="locDescText" class="small" style="white-space:pre-wrap">‚Äî</div>
      <div class="field"><button class="btn" id="lookBtn">üëÄ –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</button></div>
      <div id="pickedInfo" class="small"></div>
      <div class="divider"></div>
    </div>

    <div id="myInvBlock" class="hidden">
      <h2>–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
      <div id="myInv" class="grid"></div>
      <div class="divider"></div>
    </div>

    <div id="chatBlock" class="hidden">
      <h2>–ß–∞—Ç</h2>
      <div id="chat" class="chat"></div>
      <div class="field">
        <input id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
        <button class="btn" id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
const q = Object.fromEntries(new URL(location.href).searchParams.entries());
const code = (q.code || '').toUpperCase();
const meTgId = q.tgId || '';
const meNameFromQuery = q.name || 'Hero';
const api = (p, init={}) => fetch(`/api/games/${code}${p}`, init).then(r => r.json());

const you = document.getElementById('you');
const codeBadge = document.getElementById('code');
codeBadge.textContent = '–ö–æ–¥: ' + (code || '‚Äî');
you.textContent = `–í—ã: ${meNameFromQuery} (#${meTgId || 'test'})`;

// –ø—Ä–µ—Å–µ—Ç—ã –∞–≤–∞—Ç–∞—Ä–æ–≤ (dataURL –≤—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä–æ—Ç–∫–∏–µ SVG)
const AVATARS = [
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%23333"/><circle cx="64" cy="48" r="26" fill="%23bde0fe"/><rect x="26" y="82" width="76" height="30" rx="14" fill="%23bde0fe"/></svg>',
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%232d233a"/><circle cx="64" cy="50" r="24" fill="%23ffd166"/><rect x="24" y="84" width="80" height="28" rx="14" fill="%23ffd166"/></svg>',
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%23202434"/><circle cx="64" cy="50" r="24" fill="%23ff6b6b"/><rect x="24" y="84" width="80" height="28" rx="14" fill="%23ff6b6b"/></svg>',
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%2318222f"/><circle cx="64" cy="50" r="24" fill="%2390ee90"/><rect x="24" y="84" width="80" height="28" rx="14" fill="%2390ee90"/></svg>',
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%23242a36"/><circle cx="64" cy="50" r="24" fill="%23ffa3d7"/><rect x="24" y="84" width="80" height="28" rx="14" fill="%23ffa3d7"/></svg>',
  'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="%232f2a1f"/><circle cx="64" cy="50" r="24" fill="%23a3d8ff"/><rect x="24" y="84" width="80" height="28" rx="14" fill="%23a3d8ff"/></svg>'
];

const el = (id)=>document.getElementById(id);
const joinPanel = el('joinPanel');
const gmPanel = el('gmPanel');
const playerPanel = el('playerPanel');
const diceBar = el('diceBar');
const locBlock = el('locBlock');
const myInvBlock = el('myInvBlock');
const chatBlock = el('chatBlock');

const presetWrap = el('presetAvatars');
let chosenAvatar = null;
AVATARS.forEach(src=>{
  const i = new Image(); i.src = src; i.className='avatar'; i.style.cursor='pointer';
  i.onclick = ()=>{ chosenAvatar = src; [...presetWrap.children].forEach(c=>c.style.outline=''); i.style.outline='2px solid #4cc3ff'; }
  presetWrap.appendChild(i);
});

async function fileToDataUrl(file){
  if(!file) return null;
  const b = await file.arrayBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(b)));
  return `data:${file.type};base64,${base64}`;
}

// --- state + UI ---
let state = null;
async function loadState(){
  if(!code) return;
  const r = await api(`?tgId=${encodeURIComponent(meTgId)}`);
  state = r;

  const isGM = !!r.isGM;
  const joined = !!r.joined;
  const started = r.status === 'started';

  // –û–Ω–±–æ—Ä–¥–∏–Ω–≥: –µ—Å–ª–∏ –Ω–µ –≤–æ—à—ë–ª –≤ –ª–æ–±–±–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ join
  joinPanel.classList.toggle('hidden', joined);
  gmPanel.classList.toggle('hidden', !isGM);
  playerPanel.classList.toggle('hidden', !joined && !isGM);

  // –ò–≥—Ä–æ–∫: –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –ª–æ–±–±–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç + –º–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å; –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –µ—â—ë –∏ –ª–æ–∫–∞—Ü–∏—é + –±–æ–ª—å—à–∏–µ –∫—É–±–∏–∫–∏
  diceBar.classList.toggle('hidden', !(joined && started));
  locBlock.classList.toggle('hidden', !(joined && started));
  myInvBlock.classList.toggle('hidden', !joined);
  chatBlock.classList.toggle('hidden', !joined);

  // –ì–ú: ¬´–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è¬ª —É –Ω–µ–≥–æ –Ω–µ—Ç ‚Äî –∏ –Ω–µ –±—É–¥–µ—Ç –≤ UI

  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–¥–ª—è –ì–ú–∞)
  if(isGM){
    const list = el('playersList');
    list.innerHTML = '';
    r.players.forEach(p=>{
      const d = document.createElement('div'); d.className='p';
      d.innerHTML = `
        <div class="flex">
          ${p.photo ? `<img class="avatar" src="${p.photo}">` : `<div class="avatar" style="background:#222"></div>`}
          <div><b>${p.name}</b> <span class="small">(#${p.userTgId})</span><br>
            <span class="small">HP: ${p.hp} ‚Ä¢ Gold: ${p.gold}</span>
          </div>
        </div>
        <div class="field">
          <button class="btn bad" data-act="hp-" data-id="${p.userTgId}">-HP</button>
          <button class="btn good" data-act="hp+" data-id="${p.userTgId}">+HP</button>
          <button class="btn" data-act="gold+" data-id="${p.userTgId}">+Gold</button>
          <button class="btn" data-act="gold-" data-id="${p.userTgId}">-Gold</button>
        </div>
        <div class="field"><textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞‚Ä¶" data-note="${p.userTgId}">${p.note||''}</textarea></div>
        <div class="field"><button class="btn" data-act="save-note" data-id="${p.userTgId}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button></div>
      `;
      list.appendChild(d);
    });

    // –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ ¬´–≤—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É¬ª
    const sel = el('gmGiveTo');
    sel.innerHTML = '<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ‚Äî</option>';
    r.players.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.userTgId; o.textContent = `${p.name} (#${p.userTgId})`;
      sel.appendChild(o);
    });

    // —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π
    const locList = el('locList'); locList.innerHTML = '';
    const locs = await api('/locations');
    locs.forEach(l=>{
      const card = document.createElement('div');
      card.className='p';
      card.innerHTML = `
        <div><b>${l.title}</b></div>
        ${l.image ? `<div style="margin:6px 0"><img src="${l.image}" style="width:100%;max-height:140px;object-fit:cover;border-radius:8px;border:1px solid #2a3040"></div>`:''}
        <div class="small" style="white-space:pre-wrap">${l.description||''}</div>
        <div class="field"><button class="btn" data-make="${l.id}">–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π</button></div>
      `;
      locList.appendChild(card);
    });
    locList.onclick = async (e)=>{
      const id = e.target?.dataset?.make;
      if(!id) return;
      await api(`/locations/${id}/make-current`, { method:'POST' });
      await loadState();
    };

    // —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ HP/Gold/Note
    el('playersList').onclick = async (e)=>{
      const act = e.target?.dataset?.act;
      const id  = e.target?.dataset?.id;
      if(!act || !id) return;

      const p = r.players.find(x=>x.userTgId===id);
      if(!p) return;

      if(act==='hp-'||act==='hp+'){
        const hp = p.hp + (act==='hp+'? +1 : -1);
        await api(`/players/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ hp }) });
      }
      if(act==='gold-'||act==='gold+'){
        const gold = p.gold + (act==='gold+'? +1 : -1);
        await api(`/players/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ gold }) });
      }
      if(act==='save-note'){
        const ta = el('playersList').querySelector(`textarea[data-note="${id}"]`);
        await api(`/players/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ note: ta.value }) });
      }
      await loadState();
    };
  }

  // —Ç–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è (–¥–ª—è –∏–≥—Ä–æ–∫–∞)
  if(r.currentLocation){
    el('locName').textContent = r.currentLocation.title;
    el('locDescText').textContent = r.currentLocation.description || '';
    if(r.currentLocation.image){
      el('locImage').src = r.currentLocation.image;
      el('locImage').classList.remove('hidden');
    } else el('locImage').classList.add('hidden');
  } else {
    el('locName').textContent = '‚Äî';
    el('locDescText').textContent = '‚Äî';
    el('locImage').classList.add('hidden');
  }

  // –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä–æ–∫–∞
  if(r.joined){
    const inv = await api(`/items?ownerTgId=${encodeURIComponent(meTgId)}`);
    const box = el('myInv'); box.innerHTML = '';
    if(inv.length===0) box.innerHTML = `<div class="small">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;
    inv.forEach(it=>{
      const d = document.createElement('div'); d.className='p';
      d.innerHTML = `<b>${it.name}</b>${it.qty>1?` √ó${it.qty}`:''}<div class="small">${it.type}</div>`;
      box.appendChild(d);
    });
  }

  // —á–∞—Ç (–≤–Ω–∏–∑—É)
  if(r.joined){
    const msgs = await api('/messages');
    const chat = el('chat'); chat.innerHTML='';
    msgs.forEach(m=>{
      const d = document.createElement('div'); d.className='msg';
      d.innerHTML = `<span class="small"><b>${m.name}</b>:</span> ${m.text}`;
      chat.appendChild(d);
    });
    chat.scrollTop = chat.scrollHeight;
  }
}

// –¥–µ–π—Å—Ç–≤–∏—è –ì–ú–∞
el('gmGiveBtn').onclick = async ()=>{
  const name = el('gmItemName').value.trim(); if(!name) return;
  const ownerTgId = el('gmGiveTo').value || null;
  const qty = Number(el('gmQty').value||1);
  await api('/items', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, qty, ownerTgId }) });
  el('gmItemName').value='';
  await loadState();
};
el('gmDropBtn').onclick = async ()=>{
  const name = el('gmItemName').value.trim(); if(!name) return;
  const qty = Number(el('gmQty').value||1);
  await api('/items', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, qty, ownerTgId:null }) });
  el('gmItemName').value='';
  await loadState();
};
el('gmGoldDropBtn').onclick = async ()=>{
  const amount = Number(el('gmGoldQty').value||1);
  await api('/gold/drop', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount }) });
  await loadState();
};

// –ª–æ–∫–∞—Ü–∏–∏: –¥–æ–±–∞–≤–∏—Ç—å + –Ω–∞—á–∞—Ç—å
el('addLocBtn').onclick = async ()=>{
  const title = el('locTitle').value.trim(); if(!title) return;
  const description = el('locDesc').value;
  let image = null;
  const file = el('locImg').files[0];
  if(file) image = await fileToDataUrl(file);
  await api('/locations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, description, image }) });
  el('locTitle').value=''; el('locDesc').value=''; el('locImg').value='';
  await loadState();
};
el('startGameBtn').onclick = async ()=>{ await api('/start', { method:'POST' }); await loadState(); };

// –≤—Ö–æ–¥ –≤ –ª–æ–±–±–∏ (–∏–º—è + –∞–≤–∞—Ç–∞—Ä)
el('joinBtn').onclick = async ()=>{
  const name = el('nameInput').value.trim() || 'Hero';
  let photo = chosenAvatar;
  const f = el('photoFile').files[0];
  if(f) photo = await fileToDataUrl(f);
  await api('/join', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tgId: meTgId, name, photo }) });
  await loadState();
};

// –±—Ä–æ—Å–∫–∏ (–∫—Ä—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏)
diceBar.onclick = async (e)=>{
  const d = Number(e.target?.dataset?.d); if(!d) return;
  const res = await api('/roll', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tgId: meTgId, die: d }) });
  if(res?.result!=null){
    const info = el('pickedInfo');
    info.textContent = `–ë—Ä–æ—Å–æ–∫ d${d}: ${res.result}`;
    setTimeout(()=>info.textContent='', 2000);
  }
};

// –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è: –∑–∞–±–∏—Ä–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É
el('lookBtn').onclick = async ()=>{
  const res = await api('/look-around', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tgId: meTgId }) });
  const info = el('pickedInfo');
  if(res?.picked) info.textContent = `–ü–æ–¥–æ–±—Ä–∞–Ω–æ: ${res.picked.name}${res.picked.qty>1?' √ó'+res.picked.qty:''}`;
  else info.textContent = `–ó–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.`;
  setTimeout(()=>info.textContent='', 2000);
  await loadState();
};

// —á–∞—Ç
el('chatSend').onclick = async ()=>{
  const t = el('chatInput').value.trim(); if(!t) return;
  await api('/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tgId: meTgId, name: (state?.me?.name||meNameFromQuery), text: t }) });
  el('chatInput').value='';
  await loadState();
};

// polling –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π
setInterval(()=>{ if(code) loadState(); }, 4000);
loadState();
</script>
</body>
</html>
