<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DnD Mini App</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --line:#2a2f3a; --txt:#e6eaf2; --muted:#9aa4b2; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--txt); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    header{ padding:16px 16px 0; }
    h1{ margin:0 0 12px; font-size:20px; }
    main{ padding:16px; display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ main{ grid-template-columns: 360px 1fr; } }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .muted{ color:var(--muted) }
    .btn{ background:#2a2f3a; border:1px solid #394354; padding:8px 12px; border-radius:10px; color:var(--txt); cursor:pointer }
    .btn.small{ padding:4px 8px; font-size:13px }
    .btn.good{ background:#244a32; border-color:#2b6642 }
    .btn.warn{ background:#4a2a2a; border-color:#6a3a3a }
    input, textarea, select{ background:#0f131b; border:1px solid #2a2f3a; color:var(--txt); padding:8px 10px; border-radius:10px; width:100% }
    textarea{ min-height:70px; resize:vertical }
    .col{ display:flex; flex-direction:column; gap:10px }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-block; padding:4px 10px; border:1px solid var(--line); background:#11151d; border-radius:999px; font-size:12px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px }
    .hr{ height:1px; background:var(--line); margin:8px 0 }
    .chat{ height:220px; overflow:auto; border:1px solid var(--line); border-radius:10px; padding:8px; background:#0f131b }
    .item{ display:flex; justify-content:space-between; gap:10px; padding:8px; border:1px dashed var(--line); border-radius:10px; }
    .tag{ font-size:12px; color:#c0c8d4 }
  </style>
</head>
<body>
<header><h1>DnD Mini App</h1></header>

<main>
  <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
  <section class="card col" id="left">
    <div class="row" id="whoRow">
      <div class="muted">–í—ã: <span id="who"></span></div>
      <span class="pill">–ö–æ–¥: <span id="gameCode">‚Äî</span></span>
    </div>

    <div id="lobbyCard" class="card" style="background:#121720">
      <h3>–õ–æ–±–±–∏</h3>
      <div id="lobbyJoin" class="col">
        <div class="muted">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–æ–±–±–∏.</div>
        <input id="nameInput" placeholder="–í–∞—à–µ –∏–º—è"/>
        <button class="btn" id="joinBtn">–í–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏</button>
      </div>
      <div id="lobbyInside" class="col" style="display:none">
        <div class="list" id="playersList"></div>
        <div class="hr"></div>
        <div class="chat" id="chatBox"></div>
        <div class="row">
          <input id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ª–æ–±–±–∏‚Ä¶"/>
          <button class="btn small" id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="card col">
      <div class="muted">–õ–æ–∫–∞—Ü–∏—è: <b id="locationNow">‚Äî</b></div>
      <div class="row">
        <button class="btn small" data-die="6">üé≤ d6</button>
        <button class="btn small" data-die="8">üé≤ d8</button>
        <button class="btn small" data-die="20">üé≤ d20</button>
        <button class="btn small good" id="lookBtn">üëÄ –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</button>
      </div>
      <div id="rollsBox" class="list"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞ -->
    <div class="card col" id="gmPanel" style="display:none">
      <h3>–ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h3>
      <div class="list" id="gmPlayers"></div>
      <div class="hr"></div>

      <div class="col">
        <div class="muted">–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –±—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø–æ–ª</div>
        <input id="gmItemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–º–µ—á, –∑–µ–ª—å–µ‚Ä¶)">
        <div class="row">
          <select id="gmItemPlayer"></select>
          <button class="btn small" id="gmGiveItem">–í—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
          <button class="btn small" id="gmDropItem">–ù–∞ –ø–æ–ª</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="gmGoldAmt" style="max-width:120px" value="1">
        <button class="btn small" id="gmDropGold">–ë—Ä–æ—Å–∏—Ç—å –∑–æ–ª–æ—Ç–æ –Ω–∞ –ø–æ–ª</button>
      </div>

      <div class="hr"></div>

      <div class="col">
        <div class="muted">–õ–æ–∫–∞—Ü–∏–∏</div>
        <div class="row">
          <input id="locTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏">
        </div>
        <textarea id="locDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏"></textarea>
        <div class="row">
          <button class="btn small" id="addLoc">+ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
          <button class="btn small good" id="startGame">‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
        <div class="list" id="locList"></div>
      </div>
    </div>
  </section>

  <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
  <section class="card col">
    <div class="col">
      <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä—ã</h3>
      <div id="gameItems" class="list"></div>
    </div>
    <div class="hr"></div>
    <div class="col">
      <h3>–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
      <div id="myItems" class="list"></div>
    </div>
  </section>
</main>

<script>
  const tg = window.Telegram?.WebApp;

  // a) –∏–∑ TG-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  let userFromTG = tg?.initDataUnsafe?.user;
  // b) –∏–∑ query (–±–æ—Ç —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ URL –∫–Ω–æ–ø–∫–∏)
  const params = new URLSearchParams(location.search);
  const tgIdFromUrl = params.get('tgId');
  const nameFromUrl  = params.get('name');

  let user;
  if (userFromTG?.id) {
    user = { id: String(userFromTG.id), first_name: userFromTG.first_name || 'Hero' };
  } else if (tgIdFromUrl) {
    user = { id: String(tgIdFromUrl), first_name: nameFromUrl || 'Hero' };
  } else {
    user = { id: 'test', first_name: 'Hero' }; // –∫—Ä–∞–π–Ω–∏–π —Ä–µ–∑–µ—Ä–≤
  }

  const code = (params.get('code') || '').toUpperCase();
  document.getElementById('who').textContent = `${user.first_name} (#${user.id})`;
  document.getElementById('gameCode').textContent = code || '‚Äî';

  if ((!userFromTG || !userFromTG.id) && !tgIdFromUrl) {
    const warn = document.createElement('div');
    warn.style.cssText = 'background:#3b1d1d;color:#ffb3b3;border:1px solid #5a2a2a;padding:10px;border-radius:8px;margin-bottom:10px';
    warn.innerHTML = `<b>–ú–∏–Ω–∏‚Äë–∞–ø–ø–∞ –±–µ–∑ Telegram‚Äë–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.</b> –û—Ç–∫—Ä–æ–π—Ç–µ –µ—ë –∏–∑ —á–∞—Ç–∞ –±–æ—Ç–∞ (–∫–æ–º–∞–Ω–¥–∞ <code>/app ${code||'–ö–û–î'}</code>).`;
    document.querySelector('#left').prepend(warn);
  }

  const API = {
    game:   () => fetch(`/api/games/${code}?tgId=${encodeURIComponent(user.id)}`).then(r=>r.json()),
    join:   (name) => fetch(`/api/games/${code}/join`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tgId:user.id, name})}).then(r=>r.json()),
    msgs:   () => fetch(`/api/games/${code}/messages`).then(r=>r.json()),
    sendMsg:(text)=> fetch(`/api/games/${code}/messages`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tgId:user.id, name:user.first_name, text})}).then(r=>r.json()),
    roll:   (die)=> fetch(`/api/games/${code}/roll`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tgId:user.id, die})}).then(r=>r.json()),
    items:  (ownerTgId)=> fetch(`/api/games/${code}/items${ownerTgId?`?ownerTgId=${ownerTgId}`:''}`).then(r=>r.json()),
    dropGold:(amt)=> fetch(`/api/games/${code}/gold/drop`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({amount:amt})}).then(r=>r.json()),
    giveItem:(name, ownerTgId)=> fetch(`/api/games/${code}/items`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, ownerTgId})}).then(r=>r.json()),
    dropItem:(name)=> fetch(`/api/games/${code}/items`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})}).then(r=>r.json()),
    transfer:(itemId, toTg)=> fetch(`/api/games/${code}/items/${itemId}/transfer`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({toTgId:toTg})}).then(r=>r.json()),
    delItem:(itemId)=> fetch(`/api/games/${code}/items/${itemId}`, {method:'DELETE'}).then(r=>r.json()),
    look:   ()=> fetch(`/api/games/${code}/look-around`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tgId:user.id})}).then(r=>r.json()),
    updPlayer:(tgId, data)=> fetch(`/api/games/${code}/players/${tgId}`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(r=>r.json()),
    locs:    ()=> fetch(`/api/games/${code}/locations`).then(r=>r.json()),
    addLoc:  (title, description)=> fetch(`/api/games/${code}/locations`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title, description})}).then(r=>r.json()),
    start:   ()=> fetch(`/api/games/${code}/start`, {method:'POST'}).then(r=>r.json()),
    makeCurrent:(locId)=> fetch(`/api/games/${code}/locations/${locId}/make-current`, {method:'POST'}).then(r=>r.json()),
  };

  const el = id => document.getElementById(id);

  // UI handlers
  el('joinBtn').onclick = async () => {
    const name = el('nameInput').value.trim() || user.first_name || 'Hero';
    const r = await API.join(name);
    if (r?.ok) {
      user.first_name = name;
      reloadAll();
    } else alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏');
  };

  el('chatSend').onclick = async () => {
    const t = el('chatInput').value.trim();
    if (!t) return;
    await API.sendMsg(t);
    el('chatInput').value = '';
    loadChat();
  };

  document.querySelectorAll('[data-die]').forEach(b=>{
    b.onclick = async ()=> {
      const die = Number(b.dataset.die);
      const r = await API.roll(die);
      if (r?.result) loadRolls();
    }
  });
  el('lookBtn').onclick = async ()=> { await API.look(); reloadAll(); };

  // GM buttons
  el('gmGiveItem').onclick = async ()=>{
    const name = el('gmItemName').value.trim();
    const to = el('gmItemPlayer').value;
    if (!name || !to) return;
    await API.giveItem(name, to);
    el('gmItemName').value = '';
    reloadAll();
  };
  el('gmDropItem').onclick = async ()=>{
    const name = el('gmItemName').value.trim();
    if (!name) return;
    await API.dropItem(name);
    el('gmItemName').value = '';
    reloadAll();
  };
  el('gmDropGold').onclick = async ()=>{
    const n = Number(el('gmGoldAmt').value || 1);
    await API.dropGold(n);
    reloadAll();
  };
  el('addLoc').onclick = async ()=>{
    const t = el('locTitle').value.trim();
    const d = el('locDesc').value.trim();
    if (!t) return;
    await API.addLoc(t, d);
    el('locTitle').value=''; el('locDesc').value='';
    loadLocs();
  };
  el('startGame').onclick = async ()=>{ await API.start(); reloadAll(); };

  // loaders
  async function loadGame() {
    if (!code) return;
    const g = await API.game();
    if (g?.error) return;

    // GM?
    el('gmPanel').style.display = g.isGM ? '' : 'none';

    // –õ–æ–±–±–∏/—á–∞—Ç
    const meIn = (g.players||[]).some(p=> String(p.tgId)===String(user.id));
    el('lobbyJoin').style.display = meIn ? 'none' : '';
    el('lobbyInside').style.display = meIn ? '' : 'none';

    // –ò–≥—Ä–æ–∫–∏ —Å–ø–∏—Å–æ–∫ (–≤–∏–¥–µ–Ω –≤—Å–µ–º)
    const list = el('playersList'); list.innerHTML='';
    (g.players||[]).forEach(p=>{
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `<div><b>${p.name}</b> <span class="tag">#${p.tgId}</span><br>HP: ${p.hp} ‚Ä¢ Gold: ${p.gold}</div>`;
      list.appendChild(row);
    });

    // GM: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞–º–∏
    if (g.isGM) {
      const gp = el('gmPlayers'); gp.innerHTML='';
      (g.players||[]).forEach(p=>{
        const d = document.createElement('div');
        d.className='item';
        d.innerHTML = `
          <div><b>${p.name}</b> <span class="tag">#${p.tgId}</span><br>HP: ${p.hp} ‚Ä¢ Gold: ${p.gold}</div>
          <div class="row">
            <button class="btn small" data-a="hp-" data-id="${p.tgId}">-HP</button>
            <button class="btn small" data-a="hp+" data-id="${p.tgId}">+HP</button>
            <button class="btn small" data-a="gold+" data-id="${p.tgId}">+Gold</button>
            <button class="btn small" data-a="gold-" data-id="${p.tgId}">-Gold</button>
          </div>
        `;
        gp.appendChild(d);
      });
      gp.querySelectorAll('button').forEach(b=>{
        b.onclick = async ()=>{
          const tgId = b.dataset.id;
          const a = b.dataset.a;
          const pl = (g.players||[]).find(x=> String(x.tgId)===String(tgId));
          if (!pl) return;
          if (a==='hp-')  await API.updPlayer(tgId, { hp: pl.hp-1 });
          if (a==='hp+')  await API.updPlayer(tgId, { hp: pl.hp+1 });
          if (a==='gold+')await API.updPlayer(tgId, { gold: pl.gold+1 });
          if (a==='gold-')await API.updPlayer(tgId, { gold: Math.max(0, pl.gold-1) });
          reloadAll();
        }
      });

      // —Å–µ–ª–µ–∫—Ç –∏–≥—Ä–æ–∫–∞ –¥–ª—è –≤—ã–¥–∞—á–∏
      const sel = el('gmItemPlayer'); sel.innerHTML = '<option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ‚Äî</option>';
      (g.players||[]).forEach(p=>{
        const o = document.createElement('option');
        o.value = p.tgId; o.textContent = `${p.name} (#${p.tgId})`;
        sel.appendChild(o);
      });
    }

    // –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è
    el('locationNow').textContent = g.currentLocation ? g.currentLocation.title : '‚Äî';

    // –õ–æ–∫–∞—Ü–∏–∏ —Å–ø–∏—Å–æ–∫ (–≤ GM –ø–∞–Ω–µ–ª–∏)
    await loadLocs();

    // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
    await loadItems();
    await loadMyItems();

    // –ë—Ä–æ—Å–∫–∏
    await loadRolls();
  }

  async function loadLocs() {
    if (!code) return;
    const locs = await API.locs();
    const box = el('locList'); box.innerHTML='';
    (locs||[]).forEach(l=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div><b>${l.title}</b><div class="muted" style="max-width:520px">${l.description||''}</div></div>`;
      if (el('gmPanel').style.display!=='none') {
        const btn = document.createElement('button');
        btn.className='btn small'; btn.textContent='–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π';
        btn.onclick = async ()=>{ await API.makeCurrent(l.id); reloadAll(); };
        row.appendChild(btn);
      }
      box.appendChild(row);
    })
  }

  async function loadChat() {
    const msgs = await API.msgs();
    const box = el('chatBox'); box.innerHTML='';
    (msgs||[]).reverse().forEach(m=>{
      const div = document.createElement('div');
      div.innerHTML = `<b>${m.name}</b>: ${m.text} <span class="muted" style="font-size:12px">(${new Date(m.at).toLocaleTimeString()})</span>`;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function loadRolls() {
    const g = await API.game();
    const box = el('rollsBox'); box.innerHTML='';
    (g.rolls||[]).forEach(r=>{
      const div = document.createElement('div');
      div.className='item';
      div.innerHTML = `<div>üé≤ ${r.name} –±—Ä–æ—Å–∏–ª d${r.die}: <b>${r.result}</b></div><div class="muted">${new Date(r.at).toLocaleTimeString()}</div>`;
      box.appendChild(div);
    });
  }

  async function loadItems() {
    const items = await API.items();
    const box = el('gameItems'); box.innerHTML='';
    (items||[]).filter(i=>i.locationId).forEach(i=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div><b>${i.name}</b> ${i.type==='gold'?`<span class="tag">–ó–æ–ª–æ—Ç–æ √ó${i.qty}</span>`:''}</div>`;
      if (el('gmPanel').style.display!=='none') {
        const d = document.createElement('button'); d.className='btn small warn'; d.textContent='–£–¥–∞–ª–∏—Ç—å';
        d.onclick = async ()=>{ await API.delItem(i.id); reloadAll(); };
        row.appendChild(d);
      }
      box.appendChild(row);
    });
  }

  async function loadMyItems() {
    const items = await API.items(user.id);
    const box = el('myItems'); box.innerHTML='';
    (items||[]).forEach(i=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div><b>${i.name}</b> ${i.type==='gold'?`<span class="tag">–ó–æ–ª–æ—Ç–æ √ó${i.qty}</span>`:''}</div>`;
      box.appendChild(row);
    });
  }

  function reloadAll() { loadGame(); loadChat(); }

  // –∞–≤—Ç–æ‚Äë–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  setInterval(reloadAll, 3000);

  // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω
  (async () => {
    // –µ—Å–ª–∏ –∑–∞—à–ª–∏ –ø–æ –≥–æ–ª–æ–π —Å—Å—ã–ª–∫–µ –±–µ–∑ –∫–æ–¥–∞ ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –∏–≥—Ä—É –¥–ª—è –ì–ú–∞
    if (!code) {
      // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥—Å–∫–∞–∑–∫—É
    }
    await loadGame();
    await loadChat();
  })();
</script>
</body>
</html>
