<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>DnD Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f1115; --card:#161a22; --muted:#8e9bb3;
      --border:#232838; --accent:#4da3ff; --text:#e8eaf0;
    }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif }
    .wrap { max-width: 820px; margin: 24px auto; padding: 0 16px }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:14px }
    .row { display:flex; gap:12px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:10px; }
    h2,h3 { margin:0 0 8px; }
    input, button, textarea, select {
      background:#101522; border:1px solid var(--border); color:var(--text);
      padding:12px 12px; border-radius:10px; font-size:16px;
    }
    textarea { min-height: 80px; resize: vertical; }
    button { cursor:pointer }
    .muted { color: var(--muted) }
    .badge { display:inline-block; background:#1b2436; border:1px solid #2a3552; padding:4px 10px; border-radius:10px; }
    .avatars { display:flex; gap:10px; margin-top:10px; }
    .av { width:44px; height:44px; border-radius:50%; border:2px solid transparent; display:flex; align-items:center; justify-content:center; background:#0f1320; }
    .av.active { border-color: var(--accent) }
    .pill { padding:6px 10px; border:1px solid var(--border); border-radius:999px; display:inline-block; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .player { display:flex; align-items:center; gap:8px; }
    .divider { height:1px; background:var(--border); margin:10px 0; }
    .big { font-size:18px; padding:14px 16px; }
    .dice-grid { display:flex; gap:10px; }
    img.loc { max-width:100%; border-radius:12px; border:1px solid var(--border); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <h2>DnD Mini App</h2>
          <div class="badge" id="badgeCode">–ö–æ–¥: ‚Äî‚Äî‚Äî‚Äî</div>
        </div>
        <div id="whoami" class="muted"></div>
      </div>
    </div>

    <!-- –í–•–û–î –í –õ–û–ë–ë–ò -->
    <div id="joinCard" class="card">
      <h3>–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</h3>
      <div class="row">
        <input id="name" placeholder="–í–∞—à–µ –∏–º—è" style="flex:1" />
        <button id="btnJoin">–í–æ–π—Ç–∏</button>
      </div>
      <div class="muted" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</div>
      <div class="avatars" id="avatars"></div>
      <div class="muted" style="margin-top:8px">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞</div>
    </div>

    <!-- –õ–û–ë–ë–ò / –ò–ù–§–û -->
    <div id="lobbyCard" class="card" style="display:none">
      <h3>–õ–æ–±–±–∏</h3>
      <div class="grid">
        <div class="col">
          <div><b>–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</b></div>
          <div id="myDesc" class="muted">‚Äî</div>
          <div><b>–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</b></div>
          <div id="myInv" class="list">‚Äî</div>
        </div>
        <div class="col">
          <div><b>–ò–≥—Ä–æ–∫–∏</b></div>
          <div id="players" class="list"></div>
        </div>
      </div>
    </div>

    <!-- –ò–ì–†–ê: –ü–ê–ù–ï–õ–¨ –ë–†–û–°–ö–û–í (–≤–≤–µ—Ä—Ö—É, –∫—Ä—É–ø–Ω–æ) -->
    <div id="rollCard" class="card" style="display:none">
      <h3>–ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–æ–≤</h3>
      <div class="dice-grid">
        <button class="big" onclick="roll(6)">üé≤ d6</button>
        <button class="big" onclick="roll(8)">üé≤ d8</button>
        <button class="big" onclick="roll(20)">üé≤ d20</button>
      </div>
    </div>

    <!-- –ò–ì–†–ê: –õ–û–ö–ê–¶–ò–Ø + –û–°–ú–û–¢–†–ï–¢–¨–°–Ø -->
    <div id="locCard" class="card" style="display:none">
      <h3>–õ–æ–∫–∞—Ü–∏—è</h3>
      <div id="locBox" class="col">
        <div class="muted">‚Äî</div>
      </div>
      <div style="margin-top:10px">
        <button id="btnLook" onclick="lookAround()">–û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- –ß–ê–¢ -->
    <div id="chatCard" class="card" style="display:none">
      <h3>–ß–∞—Ç</h3>
      <div id="chat" class="list" style="max-height:260px; overflow:auto"></div>
      <div class="row" style="margin-top:8px">
        <input id="msg" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1" />
        <button onclick="sendMsg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ü–ê–ù–ï–õ–¨ –ì–ú -->
    <div id="gmCard" class="card" style="display:none">
      <h3>–ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</h3>
      <div class="muted">–ü—Ä–µ–¥–º–µ—Ç—ã ¬´–Ω–∞ –ø–æ–ª—É¬ª: <span id="floorCount">0</span></div>

      <div class="divider"></div>
      <div class="col">
        <b>–í—ã–¥–∞—Ç—å –∑–æ–ª–æ—Ç–æ / HP</b>
        <div class="row">
          <select id="gmPlayerSelect" style="flex:1"></select>
          <input id="gmDelta" type="number" placeholder="+/- —á–∏—Å–ª–æ" style="width:160px" />
        </div>
        <div class="row">
          <button onclick="gmAddGold(1)">+ –ì–æ–ª–¥</button>
          <button onclick="gmAddGold(-1)">- –ì–æ–ª–¥</button>
          <button onclick="gmAddHP(1)">+ HP</button>
          <button onclick="gmAddHP(-1)">- HP</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="col">
        <b>–ü—Ä–µ–¥–º–µ—Ç—ã</b>
        <div class="row">
          <input id="gmItemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" style="flex:1" />
          <button onclick="gmGiveItem()">–í—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
        </div>
        <div class="row">
          <input id="gmDropName" placeholder="–ü—Ä–µ–¥–º–µ—Ç –Ω–∞ –ø–æ–ª (–∏–ª–∏ –ø—É—Å—Ç–æ)" style="flex:1" />
          <input id="gmDropGold" type="number" placeholder="–ó–æ–ª–æ—Ç–æ –Ω–∞ –ø–æ–ª" style="width:180px" />
          <button onclick="gmDropItem()">–ë—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø–æ–ª</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="col">
        <b>–õ–æ–∫–∞—Ü–∏–∏</b>
        <div class="row">
          <input id="locName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1" />
          <input id="locImg" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü.)" style="flex:1" />
        </div>
        <textarea id="locDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (—Ç–µ–∫—Å—Ç)"></textarea>
        <div class="row">
          <button onclick="gmAddLocation()">–î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
          <select id="locSelect" style="flex:1"></select>
          <button onclick="gmSetLocation()">–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π</button>
        </div>
      </div>

      <div class="divider"></div>
      <button class="big" onclick="gmStart()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <script>
    // ======= Client state =======
    const AVS = ["üõ°Ô∏è","üó°Ô∏è","üèπ","üßô","üßù","üê∫"];
    let selectedAvatar = AVS[0];

    const params = new URLSearchParams(location.search);
    const code = (params.get("code") || "").toUpperCase();
    const badge = document.getElementById("badgeCode");
    badge.textContent = "–ö–æ–¥: " + (code || "‚Äî");

    const tgId = String(
      (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.id) ||
      ("anon_" + Math.floor(Math.random()*1e9))
    );

    // avatars UI
    const avBox = document.getElementById("avatars");
    AVS.forEach((ch,i)=>{
      const d = document.createElement("div");
      d.className = "av" + (i===0 ? " active" : "");
      d.textContent = ch;
      d.onclick = () => {
        selectedAvatar = ch;
        [...avBox.children].forEach(x=>x.classList.remove("active"));
        d.classList.add("active");
      };
      avBox.appendChild(d);
    });

    // ======= API helpers =======
    async function api(path, body){
      const r = await fetch(path, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      return r.json();
    }
    async function loadState(){
      const r = await fetch(`/api/state?code=${encodeURIComponent(code)}&tgId=${encodeURIComponent(tgId)}`);
      return r.json();
    }

    // ======= UI actions =======
    document.getElementById("btnJoin").onclick = async ()=>{
      const name = document.getElementById("name").value.trim();
      if(!code){ alert("–ù–µ—Ç –∫–æ–¥–∞ –∏–≥—Ä—ã –≤ URL"); return; }
      if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è"); return; }
      const res = await api("/api/lobby/join", { code, tgId, name, avatar: selectedAvatar });
      if(!res.ok){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏"); return; }
      render(res.data);
      pollStart();
    };

    async function sendMsg(){
      const msg = document.getElementById("msg").value.trim();
      if(!msg) return;
      const res = await api("/api/chat/send", { code, tgId, text: msg });
      document.getElementById("msg").value = "";
      if(res.ok) render(res.data);
    }

    async function roll(n){
      const res = await api("/api/roll", { code, tgId, sides:n });
      if(res.ok) render(res.data);
    }

    async function lookAround(){
      const res = await api("/api/look", { code, tgId });
      if(res.ok) render(res.data);
    }

    // ======= GM actions =======
    async function gmStart(){
      const res = await api("/api/gm/start", { code, gmTgId: tgId });
      if(res.ok) render(res.data);
    }
    async function gmAddGold(sign){
      const sel = document.getElementById("gmPlayerSelect");
      const deltaEl = document.getElementById("gmDelta");
      const playerTgId = sel.value;
      let d = Number(deltaEl.value || "1");
      d = d * (sign >=0 ? 1 : -1);
      const res = await api("/api/gm/addGold", { code, gmTgId: tgId, playerTgId, delta: d });
      if(res.ok) render(res.data);
    }
    async function gmAddHP(sign){
      const sel = document.getElementById("gmPlayerSelect");
      const deltaEl = document.getElementById("gmDelta");
      const playerTgId = sel.value;
      let d = Number(deltaEl.value || "1");
      d = d * (sign >=0 ? 1 : -1);
      const res = await api("/api/gm/addHP", { code, gmTgId: tgId, playerTgId, delta: d });
      if(res.ok) render(res.data);
    }
    async function gmGiveItem(){
      const sel = document.getElementById("gmPlayerSelect");
      const name = document.getElementById("gmItemName").value.trim();
      if(!name) return;
      const res = await api("/api/gm/giveItem", { code, gmTgId: tgId, playerTgId: sel.value, name });
      if(res.ok) render(res.data);
    }
    async function gmDropItem(){
      const name = document.getElementById("gmDropName").value.trim();
      const gold = Number(document.getElementById("gmDropGold").value || "0");
      const payload = gold > 0
        ? { code, gmTgId: tgId, goldAmount: gold }
        : { code, gmTgId: tgId, name: name || "–ø—Ä–µ–¥–º–µ—Ç" };
      const res = await api("/api/gm/dropItem", payload);
      if(res.ok) render(res.data);
    }
    async function gmAddLocation(){
      const name = document.getElementById("locName").value.trim() || "–õ–æ–∫–∞—Ü–∏—è";
      const description = document.getElementById("locDesc").value.trim();
      const imageUrl = document.getElementById("locImg").value.trim();
      const res = await api("/api/gm/addLocation", { code, gmTgId: tgId, name, description, imageUrl });
      if(res.ok){
        document.getElementById("locName").value="";
        document.getElementById("locDesc").value="";
        document.getElementById("locImg").value="";
        render(res.data);
      }
    }
    async function gmSetLocation(){
      const sel = document.getElementById("locSelect");
      const res = await api("/api/gm/setLocation", { code, gmTgId: tgId, locationId: sel.value || null });
      if(res.ok) render(res.data);
    }

    // ======= Render =======
    function render(st){
      if(!st) return;
      const me = st.me;
      const isGM = me && me.isGM;
      document.getElementById("whoami").textContent = me ? `${me.name} ${me.avatar||""} ${isGM?"(–ì–ú)":""}` : "";

      // –°–∫—Ä—ã—Ç—å –≤—Å—ë –¥–æ –≤—Ö–æ–¥–∞
      document.getElementById("joinCard").style.display = me ? "none" : "block";
      document.getElementById("lobbyCard").style.display = me ? "block" : "none";

      // –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
      document.getElementById("rollCard").style.display = (me && st.game.started) ? "block" : "none";
      document.getElementById("locCard").style.display  = (me && st.game.started) ? "block" : "none";
      document.getElementById("chatCard").style.display = (me) ? "block" : "none";

      // –£ –∏–≥—Ä–æ–∫–æ–≤ ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è¬ª, —É –ì–ú–∞ –µ—ë –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
      document.getElementById("btnLook").style.display = (me && !isGM) ? "inline-block" : "none";

      // –ü–∞–Ω–µ–ª—å –ì–ú–∞
      document.getElementById("gmCard").style.display = isGM ? "block" : "none";

      // –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
      const inv = document.getElementById("myInv");
      inv.innerHTML = "";
      if (me && me.inventory && me.inventory.length) {
        me.inventory.forEach(it=>{
          const d=document.createElement("div");
          d.textContent = `‚Ä¢ ${it.name}`;
          inv.appendChild(d);
        });
      } else {
        inv.textContent = "‚Äî";
      }
      document.getElementById("myDesc").textContent = me && me.description ? me.description : "‚Äî";

      // –ò–≥—Ä–æ–∫–∏ —Å–ø–∏—Å–æ–∫
      const playersBox = document.getElementById("players");
      playersBox.innerHTML = "";
      st.players.forEach(p=>{
        const d = document.createElement("div");
        d.className="player";
        d.innerHTML = `<span class="pill">${p.avatar||"üôÇ"}</span> <b>${p.name}</b> ¬∑ HP ${p.hp} ¬∑ Gold ${p.gold}`;
        playersBox.appendChild(d);
      });

      // –ß–∞—Ç
      const chatBox = document.getElementById("chat");
      chatBox.innerHTML = "";
      st.messages.forEach(m=>{
        const author = m.authorTgId ? (st.players.find(x=>x.tgId===m.authorTgId)?.name || "–ò–≥—Ä–æ–∫") : "‚ú¶";
        const line = document.createElement("div");
        line.textContent = `${author}: ${m.text}`;
        chatBox.appendChild(line);
      });
      chatBox.scrollTop = chatBox.scrollHeight;

      // –õ–æ–∫–∞—Ü–∏—è
      const locBox = document.getElementById("locBox");
      locBox.innerHTML="";
      if(st.game.currentLocation){
        const L = st.game.currentLocation;
        if(L.imageUrl){
          const img=document.createElement("img"); img.src=L.imageUrl; img.className="loc";
          locBox.appendChild(img);
        }
        const t=document.createElement("div");
        t.innerHTML = `<b>${L.name}</b><div class="muted" style="margin-top:6px">${L.description||""}</div>`;
        locBox.appendChild(t);
      } else {
        const t=document.createElement("div");
        t.className="muted"; t.textContent="–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";
        locBox.appendChild(t);
      }

      // GM selects
      if(isGM){
        document.getElementById("floorCount").textContent = st.game.floorCount;
        const sel = document.getElementById("gmPlayerSelect");
        sel.innerHTML="";
        st.players.filter(p=>!p.isGM).forEach(p=>{
          const o=document.createElement("option");
          o.value=p.tgId; o.textContent=`${p.name} (${p.gold}g, ${p.hp}hp)`;
          sel.appendChild(o);
        });

        const locSel = document.getElementById("locSelect");
        locSel.innerHTML="";
        const o0=document.createElement("option"); o0.value=""; o0.textContent="‚Äî –Ω–µ—Ç ‚Äî";
        locSel.appendChild(o0);
        st.locations.forEach(L=>{
          const o=document.createElement("option");
          o.value=L.id; o.textContent=L.name;
          if(st.game.currentLocation && st.game.currentLocation.id===L.id) o.selected=true;
          locSel.appendChild(o);
        });
      }
    }

    // ======= Polling =======
    let pollTimer = null;
    function pollStart(){
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async ()=>{
        const r = await loadState();
        if(r.ok) render(r.data);
      }, 2000);
    }

    // –∞–≤—Ç–æ‚Äë–∑–∞–≥—Ä—É–∑–∫–∞ state (–µ—Å–ª–∏ –∫–æ–¥ –µ—Å—Ç—å)
    (async function init(){
      if(!code) return;
      const r = await loadState();
      if(r.ok){
        render(r.data);
        if(r.data.me) pollStart(); // —É–∂–µ –≤ –ª–æ–±–±–∏ ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º –æ–ø—Ä–æ—Å
      }
    })();
  </script>
</body>
</html>
