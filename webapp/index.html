<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>DnD Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0f1115;color:#e8eaf0;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    .wrap{max-width:720px;margin:24px auto;padding:0 16px}
    .card{background:#161a22;border:1px solid #232838;border-radius:12px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center}
    input,button,select{background:#0f1320;border:1px solid #2a3145;color:#e8eaf0;border-radius:10px;padding:12px;font-size:16px}
    button{cursor:pointer}
    .avatars{display:flex;gap:10px;margin-top:10px}
    .av{width:42px;height:42px;border-radius:50%;border:2px solid transparent;display:flex;align-items:center;justify-content:center;background:#0f1320}
    .av.active{border-color:#4da3ff}
    .note{opacity:.7}
    .badge{display:inline-block;background:#1e2638;border:1px solid #2e3a57;padding:4px 8px;border-radius:8px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Dnd Mini App</h2>
        <div class="badge" id="codeBadge">–ö–æ–¥: ‚Äî‚Äî‚Äî‚Äî</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</h3>
      <div class="row">
        <input id="name" placeholder="–í–∞—à–µ –∏–º—è" style="flex:1" />
        <button id="joinBtn">–í–æ–π—Ç–∏</button>
      </div>
      <div class="note" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</div>
      <div class="avatars" id="avatars"></div>
      <div class="note" style="margin-top:8px">–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —É–≤–∏–¥–∏—Ç–µ —á–∞—Ç –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
    </div>

    <div class="card" id="afterJoin" style="display:none">
      <h3 style="margin-top:0">–í—ã –≤ –ª–æ–±–±–∏ ‚úÖ</h3>
      <div id="players"></div>
    </div>
  </div>

  <script>
    const AVS = ["üõ°Ô∏è","üó°Ô∏è","üèπ","üßô","üßù","üê∫"];
    let selectedAvatar = AVS[0];
    const tgId = (window.Telegram?.WebApp?.initDataUnsafe?.user?.id || Math.floor(Math.random()*1e9)).toString();

    // parse code= from URL
    const params = new URLSearchParams(location.search);
    const code = (params.get("code") || "").toUpperCase();
    document.getElementById("codeBadge").textContent = "–ö–æ–¥: " + (code || "‚Äî‚Äî‚Äî");

    // avatars UI
    const avBox = document.getElementById("avatars");
    AVS.forEach((ch, i) => {
      const d = document.createElement("div");
      d.className = "av" + (i===0 ? " active" : "");
      d.textContent = ch;
      d.onclick = () => {
        selectedAvatar = ch;
        [...avBox.children].forEach(x => x.classList.remove("active"));
        d.classList.add("active");
      };
      avBox.appendChild(d);
    });

    async function joinLobby(){
      const name = document.getElementById("name").value.trim();
      if(!code){ alert("–ù–µ—Ç –∫–æ–¥–∞ –∏–≥—Ä—ã –≤ URL."); return; }
      if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è."); return; }
      try{
        const r = await fetch(`/api/game/${code}/lobby/join`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ tgId, name, avatar: selectedAvatar })
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || "join failed");
        document.getElementById("afterJoin").style.display = "block";
        await refreshPlayers();
        alert("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!");
      }catch(e){
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏");
      }
    }

    async function refreshPlayers(){
      try{
        const r = await fetch(`/api/game/${code}`);
        const j = await r.json();
        if(!j.ok) return;
        const box = document.getElementById("players");
        box.innerHTML = "";
        j.game.players.forEach(p=>{
          const d = document.createElement("div");
          d.textContent = `${p.name} ${p.avatar || ""} ‚Äî gold:${p.gold} hp:${p.hp}`;
          box.appendChild(d);
        });
      }catch(e){}
    }

    document.getElementById("joinBtn").onclick = joinLobby;
  </script>
</body>
</html>
