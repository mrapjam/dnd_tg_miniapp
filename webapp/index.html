<!-- public/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Dnd Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg:#0d0f12; --panel:#161a20; --muted:#8ea0b3; --text:#e8eef7; --accent:#6ea8fe; --ok:#5dd39e; --danger:#ef6b73;
      --card:#1c222b; --border:#263042;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .title { font-weight:700; margin-bottom:8px; }
    .muted { color:var(--muted); font-size: 14px; }
    .btn { background:#243043; border:1px solid var(--border); padding:10px 14px; border-radius:10px; color:#fff; cursor:pointer; }
    .btn.primary { background:var(--accent); border:none; }
    .btn.ok { background:var(--ok); border:none; color:#0c1920; }
    .btn.danger { background:var(--danger); border:none; }
    .btn.block { width:100%; }
    .pill { display:inline-block; padding:4px 8px; background:#1f2733; border:1px solid var(--border); border-radius:999px; margin-right:8px; font-size:12px; }
    .input, .textarea, .select { width:100%; background:#10151d; border:1px solid var(--border); color:#fff; border-radius:10px; padding:10px; }
    .textarea { min-height:68px; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .rowcenter { display:flex; align-items:center; gap:8px; }
    .bigrolls { display:flex; gap:12px; margin: 4px 0 8px; }
    .bigrolls .btn { font-size:18px; padding:14px 16px; }
    .avatar-grid { display:grid; grid-template-columns: repeat(6, 42px); gap:10px; margin-top:8px; }
    .avatar { width:42px; height:42px; border-radius:50%; border:2px solid transparent; cursor:pointer; display:flex; align-items:center; justify-content:center; background:#0e141c; }
    .avatar.selected { border-color: var(--accent); }
    img.loc { max-width:100%; border-radius:10px; border:1px solid var(--border); }
    .chat { max-height:260px; overflow:auto; background:#0d1219; border:1px solid var(--border); border-radius:10px; padding:10px; }
    .chat .msg { margin-bottom:6px; }
    .chat .who { color:#9fc2ff; margin-right:6px; }
    .players .pl { padding:8px; border:1px solid var(--border); border-radius:10px; background:#121821; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="rowcenter">
        <div class="title">Dnd Mini App</div>
        <div id="topCode" class="pill"></div>
      </div>
      <div class="muted" id="who"></div>
    </div>

    <!-- –ë–ª–æ–∫ ¬´–≤—Ö–æ–¥ –≤ –ª–æ–±–±–∏¬ª -->
    <div class="card" id="lobbyEnter">
      <div class="title">–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</div>
      <div class="row" style="gap:8px;">
        <input id="inpName" class="input" placeholder="–í–∞—à–µ –∏–º—è" />
        <button id="btnEnterLobby" class="btn primary">–í–æ–π—Ç–∏</button>
      </div>
      <div class="muted" style="margin-top:8px;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</div>
      <div class="avatar-grid" id="avatarGrid"></div>
      <div class="muted" style="margin-top:8px;">–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —É–≤–∏–¥–∏—Ç–µ —á–∞—Ç –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
    </div>

    <!-- –ë—Ä–æ—Å–∫–∏ (–≤–∏–¥–Ω–æ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã) -->
    <div class="card" id="rollsPanel" style="display:none;">
      <div class="title">–ë—Ä–æ—Å–æ–∫</div>
      <div class="bigrolls">
        <button class="btn ok" data-roll="6">üé≤ d6</button>
        <button class="btn ok" data-roll="8">üé≤ d8</button>
        <button class="btn ok" data-roll="20">üé≤ d20</button>
      </div>
      <div class="muted" id="rollResult"></div>
    </div>

    <!-- –õ–æ–∫–∞—Ü–∏—è -->
    <div class="card" id="locationPanel" style="display:none;">
      <div class="title">–õ–æ–∫–∞—Ü–∏—è: <span id="locTitle">‚Äî</span></div>
      <div class="muted" id="locDescr">‚Äî</div>
      <div id="locImageWrap" style="margin-top:8px;"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnLook" class="btn">–û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è</button>
        <div class="muted" id="floorCount" style="align-self:center;"></div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞ -->
    <div class="card" id="gmPanel" style="display:none;">
      <div class="title">–ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞</div>
      <div class="row">
        <div class="col">
          <div class="title muted">–ò–≥—Ä–æ–∫–∏</div>
          <div id="playersList" class="players list"></div>
          <div class="title muted" style="margin-top:12px;">–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç / –ù–∞ –ø–æ–ª</div>
          <input id="gmItemTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" />
          <div class="row" style="margin-top:8px;">
            <select id="gmTarget" class="select"></select>
            <button id="gmGiveItem" class="btn">–í—ã–¥–∞—Ç—å –∏–≥—Ä–æ–∫—É</button>
            <button id="gmDropItem" class="btn">–ù–∞ –ø–æ–ª</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <input id="gmGoldAmt" class="input" value="1" />
            <button id="gmGoldFloor" class="btn">–ë—Ä–æ—Å–∏—Ç—å –∑–æ–ª–æ—Ç–æ –Ω–∞ –ø–æ–ª</button>
          </div>
        </div>
        <div class="col">
          <div class="title muted">–õ–æ–∫–∞—Ü–∏–∏</div>
          <input id="gmLocTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏" />
          <textarea id="gmLocDescr" class="textarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏"></textarea>
          <input id="gmLocImage" type="file" accept="image/*" class="input" />
          <div class="row" style="margin-top:8px;">
            <button id="gmAddLoc" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
            <select id="gmLocSelect" class="select"></select>
            <button id="gmSetLoc" class="btn">–°–¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="gmStart" class="btn primary">‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏ -->
    <div class="row">
      <div class="col">
        <div class="card" id="gameInvCard" style="display:none;">
          <div class="title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä—ã</div>
          <div id="gameInv" class="list muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
        </div>
      </div>
      <div class="col">
        <div class="card" id="myInvCard" style="display:none;">
          <div class="title">–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div id="myInv" class="list muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
        </div>
      </div>
    </div>

    <!-- –ß–∞—Ç -->
    <div class="card" id="chatCard" style="display:none;">
      <div class="title">–õ–æ–±–±–∏/–ò–≥—Ä–∞ ‚Äî —á–∞—Ç</div>
      <div id="chat" class="chat"></div>
      <div class="row" style="margin-top:8px;">
        <input id="chatText" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="chatSend" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const code = (qs.get('code') || '').toUpperCase();
    const tgId = qs.get('tgId') || '';

    // –∞–≤–∞—Ç–∞—Ä—ã (–∏–∫–æ–Ω–∫–∏)
    const AVATARS = [
      'üõ°Ô∏è','üó°Ô∏è','üèπ','üßô','üßù','üê∫'
    ];
    let selectedAvatar = AVATARS[0];

    const el = (id) => document.getElementById(id);
    el('topCode').textContent = code ? `–ö–æ–¥: ${code}` : '';

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∏–¥—ã –∞–≤–∞—Ç–∞—Ä–æ–≤
    const grid = el('avatarGrid');
    AVATARS.forEach(a => {
      const div = document.createElement('div');
      div.className = 'avatar';
      if (a === selectedAvatar) div.classList.add('selected');
      div.textContent = a;
      div.onclick = () => {
        selectedAvatar = a;
        grid.querySelectorAll('.avatar').forEach(x=>x.classList.remove('selected'));
        div.classList.add('selected');
      };
      grid.appendChild(div);
    });

    // state
    let STATE = null; // server state
    async function loadState() {
      if (!code) return;
      const r = await fetch(`/api/state?code=${code}&tgId=${tgId}`);
      if (!r.ok) return;
      STATE = await r.json();
      render();
    }

    function myRole() {
      return STATE?.me?.role || 'player';
    }

    function render() {
      // –≤–µ—Ä—Ö: –∫—Ç–æ —è
      el('who').textContent = STATE?.me
        ? `–í—ã: ${STATE.me.name} (${STATE.me.role}) | HP: ${STATE.me.hp} | Gold: ${STATE.me.gold}`
        : `–í—ã: –ì–æ—Å—Ç—å`;

      const joined = !!STATE?.me;
      const started = !!STATE?.game?.started;

      // 1) –í–•–û–î –í –õ–û–ë–ë–ò
      el('lobbyEnter').style.display = joined ? 'none' : 'block';

      // 2) GM –ø–∞–Ω–µ–ª—å
      el('gmPanel').style.display = joined && myRole()==='gm' ? 'block' : 'none';

      // 3) –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏: –¥–æ –≤—Ö–æ–¥–∞ ‚Äî —Å–∫—Ä—ã—Ç–æ
      el('gameInvCard').style.display = joined ? 'block' : 'none';
      el('myInvCard').style.display   = joined ? 'block' : 'none';

      // 4) –ß–∞—Ç: –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤—Å–µ–≥–¥–∞
      el('chatCard').style.display = joined ? 'block' : 'none';

      // 5) –†–æ–ª–ª—ã/–õ–æ–∫–∞—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã
      el('rollsPanel').style.display = (joined && started) ? 'block' : 'none';
      el('locationPanel').style.display = (joined && started) ? 'block' : 'none';

      // –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π
      const gameInv = el('gameInv');
      const floor = (STATE?.floorVisible || []);
      gameInv.innerHTML = floor.length ? '' : '<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
      floor.forEach(it => {
        const d = document.createElement('div');
        d.textContent = it.kind === 'gold' ? `ü™ô –ó–æ–ª–æ—Ç–æ x${it.amount}` : `üì¶ ${it.title}`;
        gameInv.appendChild(d);
      });

      const myInv = el('myInv');
      const mine = (STATE?.myInventory || []);
      myInv.innerHTML = mine.length ? '' : '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
      mine.forEach(it => {
        const d = document.createElement('div');
        d.textContent = it.kind === 'gold' ? `ü™ô –ó–æ–ª–æ—Ç–æ x${it.amount}` : `üì¶ ${it.title}`;
        myInv.appendChild(d);
      });

      // –ª–æ–∫–∞—Ü–∏—è
      const loc = STATE?.game?.currentLocation;
      el('locTitle').textContent = loc?.title || '‚Äî';
      el('locDescr').textContent = loc?.descr || '‚Äî';
      const imgWrap = el('locImageWrap');
      imgWrap.innerHTML = '';
      if (loc?.imageUrl) {
        const im = document.createElement('img');
        im.className = 'loc';
        im.src = loc.imageUrl;
        imgWrap.appendChild(im);
      }
      el('floorCount').textContent = STATE?.floorHiddenCount ? `–ù–∞ –ø–æ–ª—É —á—Ç–æ-—Ç–æ –µ—Å—Ç—å‚Ä¶` : '';

      // GM specifics
      if (myRole()==='gm') {
        // players list + +/-
        const list = el('playersList');
        list.innerHTML = '';
        const sel = el('gmTarget');
        sel.innerHTML = '';
        (STATE?.players || []).filter(p=>p.role!=='gm').forEach(p=>{
          const r = document.createElement('div');
          r.className='pl';
          r.innerHTML = `
            <div><b>${p.name}</b> ${p.avatar||''}</div>
            <div class="muted">HP: ${p.hp} | Gold: ${p.gold}</div>
            <div class="row" style="margin-top:6px;">
              <button class="btn" data-hp="-1" data-id="${p.id}">-HP</button>
              <button class="btn" data-hp="+1" data-id="${p.id}">+HP</button>
              <button class="btn" data-gold="+1" data-id="${p.id}">+Gold</button>
              <button class="btn" data-gold="-1" data-id="${p.id}">-Gold</button>
            </div>
          `;
          list.appendChild(r);
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = p.name;
          sel.appendChild(opt);
        });

        // –ª–æ–∫–∞—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç
        const lsel = el('gmLocSelect');
        lsel.innerHTML = '';
        (STATE?.game && STATE?.game?.currentLocation ? [STATE.game.currentLocation] : []);
        (STATE?.game ? STATE.game : null);
        // –ø–æ–¥—Ç—è–Ω–µ–º –≤—Å–µ –ª–æ–∫–∞—Ü–∏–∏ –∏–∑ state.players –Ω–µ–ª—å–∑—è ‚Äî –∏—Ö –Ω–µ—Ç; –∑–∞–ø—Ä–æ—Å–∏–º –ø—Ä–∏ –∫–ª–∏–∫–µ –∫–Ω–æ–ø–∫–∏
      }
    }

    // enter lobby
    el('btnEnterLobby').onclick = async () => {
      const name = el('inpName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
      const r = await fetch('/api/join-lobby', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, name, avatar: selectedAvatar })
      });
      if (r.ok) {
        await loadState();
      } else {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏');
      }
    };

    // rolls
    document.querySelectorAll('.bigrolls .btn').forEach(b=>{
      b.onclick = () => {
        const sides = Number(b.dataset.roll);
        const v = Math.floor(Math.random()*sides)+1;
        el('rollResult').textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${v} (d${sides})`;
      };
    });

    // look
    el('btnLook').onclick = async () => {
      const r = await fetch('/api/look', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId })
      });
      const data = await r.json();
      if (data?.picked) {
        await loadState();
      }
    };

    // chat
    async function loadChat() {
      if (!code) return;
      const r = await fetch(`/api/chat?code=${code}`);
      if (!r.ok) return;
      const msgs = await r.json();
      const box = el('chat');
      box.innerHTML = '';
      msgs.forEach(m=>{
        const div = document.createElement('div');
        div.className='msg';
        div.innerHTML = `<span class="who">${m.author}:</span> ${m.text}`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
    el('chatSend').onclick = async () => {
      const t = el('chatText').value.trim();
      if (!t) return;
      await fetch('/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, text: t })
      });
      el('chatText').value='';
      loadChat();
    };

    // GM buttons
    document.addEventListener('click', async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      // +/- HP/Gold
      if (target.dataset?.hp || target.dataset?.gold) {
        const playerId = target.dataset.id;
        const hpDelta = target.dataset.hp ? Number(target.dataset.hp) : 0;
        const goldDelta = target.dataset.gold ? Number(target.dataset.gold) : 0;
        await fetch('/api/gm/adjust', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code, tgId, playerId, hpDelta, goldDelta })
        });
        await loadState();
      }
    });

    el('gmGiveItem').onclick = async () => {
      const title = el('gmItemTitle').value.trim();
      const toPlayerId = el('gmTarget').value;
      if (!title || !toPlayerId) return;
      await fetch('/api/gm/item', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, title, toPlayerId })
      });
      el('gmItemTitle').value='';
      await loadState();
    };
    el('gmDropItem').onclick = async () => {
      const title = el('gmItemTitle').value.trim();
      if (!title) return;
      await fetch('/api/gm/item', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, title, toFloor:true })
      });
      el('gmItemTitle').value='';
      await loadState();
    };
    el('gmGoldFloor').onclick = async () => {
      const amount = Number(el('gmGoldAmt').value||'1');
      await fetch('/api/gm/gold-floor', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, amount })
      });
      await loadState();
    };

    el('gmAddLoc').onclick = async () => {
      const title = el('gmLocTitle').value.trim();
      const descr = el('gmLocDescr').value.trim();
      if (!title) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏');
      const f = new FormData();
      f.append('code', code);
      f.append('tgId', tgId);
      f.append('title', title);
      f.append('descr', descr);
      const file = el('gmLocImage').files[0];
      if (file) f.append('image', file);
      await fetch('/api/gm/location', { method:'POST', body: f });
      el('gmLocTitle').value='';
      el('gmLocDescr').value='';
      el('gmLocImage').value='';
      await loadState();
    };
    el('gmSetLoc').onclick = async () => {
      // –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é/—Ç–µ–∫—É—â—É—é –Ω–µ–ª—å–∑—è –±–µ–∑ –¥–æ–ø-–∑–∞–ø—Ä–æ—Å–∞.
      // —É–ø—Ä–æ—â–µ–Ω–∏–µ: –±–µ—Ä—ë–º ID –∏–∑ prompt (–∏–ª–∏ —Å–¥–µ–ª–∞–π –≤—ã–ø–∞–¥–∞—à–∫—É ‚Äî –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Ä–∞—Å—à–∏—Ä–∏–º)
      const id = prompt('–í–≤–µ–¥–∏ ID –ª–æ–∫–∞—Ü–∏–∏ (–≤ –ø—Ä–æ–¥–µ —Å–¥–µ–ª–∞–µ–º —Å–ø–∏—Å–æ–∫)');
      if (!id) return;
      await fetch('/api/gm/set-location', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId, locationId: id })
      });
      await loadState();
    };
    el('gmStart').onclick = async () => {
      await fetch('/api/gm/start', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ code, tgId })
      });
      await loadState();
    };

    // –ø–æ–ª–ª–∏–Ω–≥
    setInterval(loadState, 2500);
    setInterval(loadChat, 2500);

    // init
    loadState(); loadChat();
  </script>
</body>
</html>
