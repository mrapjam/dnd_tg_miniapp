<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
  />
  <title>Dnd Mini App ‚Äî —á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#0f1115;color:#e7e7ea}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#181b22;border:1px solid #2a2f3a;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px}
    input,button,select{font:inherit;padding:12px;border-radius:12px;border:1px solid #2a2f3a;background:#0f1115;color:#e7e7ea}
    input{flex:1}
    button{background:#3b82f6;border-color:#3b82f6;cursor:pointer}
    small{opacity:.7}
    .players{display:flex;flex-direction:column;gap:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#2a2f3a;margin-left:8px;font-size:12px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Dnd Mini App</h2>
        <div id="gameCode" class="pill">‚Äî</div>
      </div>
      <small>–ú–∏–Ω–∏‚Äë–∫–∞—Ä–∫–∞—Å. –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–æ–±–±–∏ –Ω–∏–∂–µ.</small>
    </div>

    <div class="card" id="joinCard">
      <h3 style="margin-top:0">–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</h3>
      <div class="row">
        <input id="name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" />
        <select id="avatar">
          <option value="üõ°Ô∏è">üõ°Ô∏è</option>
          <option value="üó°Ô∏è">üó°Ô∏è</option>
          <option value="üèπ">üèπ</option>
          <option value="üßô">üßô</option>
          <option value="üßù">üßù</option>
          <option value="üê∫">üê∫</option>
        </select>
        <button id="joinBtn">–í–æ–π—Ç–∏</button>
      </div>
      <small>–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —É–≤–∏–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤.</small>
    </div>

    <div class="card" id="playersCard" style="display:none">
      <h3 style="margin-top:0">–ò–≥—Ä–æ–∫–∏</h3>
      <div class="players" id="players"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const qs = new URLSearchParams(location.search);
    const code = (qs.get('code') || '').toUpperCase();
    document.getElementById('gameCode').textContent = code || '‚Äî';

    const me = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : '';

    async function loadState() {
      if (!code) return;
      const r = await fetch(`/api/state?code=${code}&me=${me}`);
      const data = await r.json();
      if (!data.ok) return;

      if (!data.exists) {
        document.getElementById('playersCard').style.display = 'none';
        return;
      }

      const playersEl = document.getElementById('players');
      playersEl.innerHTML = '';
      data.players.forEach(p => {
        const div = document.createElement('div');
        div.textContent = `${p.avatar || 'üôÇ'} ${p.name}  ‚Ä¢  HP ${p.hp}  ‚Ä¢  Gold ${p.gold}`;
        playersEl.appendChild(div);
      });
      document.getElementById('playersCard').style.display = 'block';
    }

    document.getElementById('joinBtn').addEventListener('click', async () => {
      if (!code) { alert('–ù–µ—Ç –∫–æ–¥–∞ –∏–≥—Ä—ã –≤ URL'); return; }
      const name = document.getElementById('name').value.trim();
      const avatar = document.getElementById('avatar').value;
      const tgId = me || prompt('–í–∞—à Telegram id (–≤ –æ—Ç–ª–∞–¥–∫–µ –≤–Ω–µ Telegram):', '12345');
      if (!name || !tgId) return;

      const r = await fetch('/api/lobby/join', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ code, tgId, name, avatar })
      });
      const data = await r.json();
      if (!data.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏'); return; }
      await loadState();
    });

    loadState();
    // –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª–ª–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    setInterval(loadState, 3000);
  </script>
</body>
</html>
