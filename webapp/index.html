<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
  />
  <title>Dnd Mini App</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#0f1115;color:#e7e7ea}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    .card{background:#181b22;border:1px solid #2a2f3a;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px}
    input,button,select{font:inherit;padding:12px;border-radius:12px;border:1px solid #2a2f3a;background:#0f1115;color:#e7e7ea}
    button{background:#3b82f6;border-color:#3b82f6;cursor:pointer}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#2a2f3a;margin-left:8px;font-size:12px}
    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border:1px solid #2a2f3a;border-radius:12px}
    .gm{color:#f59e0b}
    small{opacity:.7}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Dnd Mini App</h2>
        <div>
          <span id="rolePill" class="pill">‚Äî</span>
          <span id="gameCode" class="pill">‚Äî</span>
        </div>
      </div>
      <small>–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–æ–±–±–∏. –ì–ú –≤–∏–¥–∏—Ç –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</small>
    </div>

    <div class="card" id="joinCard">
      <h3 style="margin-top:0">–í—Ö–æ–¥ –≤ –ª–æ–±–±–∏</h3>
      <div class="row">
        <input id="name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" />
        <select id="avatar">
          <option value="üõ°Ô∏è">üõ°Ô∏è</option>
          <option value="üó°Ô∏è">üó°Ô∏è</option>
          <option value="üèπ">üèπ</option>
          <option value="üßô">üßô</option>
          <option value="üßù">üßù</option>
          <option value="üê∫">üê∫</option>
        </select>
        <button id="joinBtn">–í–æ–π—Ç–∏</button>
      </div>
      <small>–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤. –ï—Å–ª–∏ –≤—ã –ì–ú, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</small>
    </div>

    <div class="card" id="playersCard" style="display:none">
      <h3 style="margin-top:0">–ò–≥—Ä–æ–∫–∏</h3>
      <div class="players" id="players"></div>
    </div>

    <div class="card" id="gmCard" style="display:none">
      <h3 style="margin-top:0">–ì–ú‚Äë–ø–∞–Ω–µ–ª—å</h3>
      <div class="row">
        <select id="gmPlayerSelect" style="flex:1"></select>
      </div>
      <div class="row" style="margin-top:8px">
        <button data-act="hp:-1">‚àí1 HP</button>
        <button data-act="hp:+1">+1 HP</button>
        <button data-act="gold:-1" style="margin-left:auto">‚àí1 –∑–æ–ª–æ—Ç–æ</button>
        <button data-act="gold:+1">+1 –∑–æ–ª–æ—Ç–æ</button>
      </div>
      <small>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞, –∑–∞—Ç–µ–º –∏–∑–º–µ–Ω—è–π—Ç–µ HP/–∑–æ–ª–æ—Ç–æ.</small>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const qs = new URLSearchParams(location.search);
    const code = (qs.get('code') || '').toUpperCase();
    const role = (qs.get('role') || '').toLowerCase();
    const me = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : '';

    document.getElementById('gameCode').textContent = code || '‚Äî';
    document.getElementById('rolePill').textContent = role ? (role === 'gm' ? '–ì–ú' : '–ò–≥—Ä–æ–∫') : '‚Äî';

    const joinCard = document.getElementById('joinCard');
    const playersCard = document.getElementById('playersCard');
    const playersEl = document.getElementById('players');
    const gmCard = document.getElementById('gmCard');
    const gmPlayerSelect = document.getElementById('gmPlayerSelect');

    async function loadState() {
      if (!code) return;
      const r = await fetch(`/api/state?code=${code}&me=${me}`);
      const data = await r.json();
      if (!data.ok || !data.exists) {
        playersCard.style.display = 'none';
        gmCard.style.display = 'none';
        return;
      }

      // —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
      playersEl.innerHTML = '';
      data.players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.innerHTML = `
          <div>${p.avatar || 'üôÇ'} <b>${p.name}</b> ${p.isGM ? '<span class="gm pill">–ì–ú</span>' : ''}</div>
          <div>HP ${p.hp} ‚Ä¢ Gold ${p.gold}</div>
        `;
        playersEl.appendChild(div);
      });
      playersCard.style.display = 'block';

      // –µ—Å–ª–∏ —ç—Ç–æ –ì–ú ‚Äî –≤–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª—å
      if (me && data.gmId === me && role === 'gm') {
        gmPlayerSelect.innerHTML = '';
        data.players.filter(p => !p.isGM).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.name} (${p.gold}g / ${p.hp}hp)`;
          gmPlayerSelect.appendChild(opt);
        });
        gmCard.style.display = 'block';
      } else {
        gmCard.style.display = 'none';
      }

      // –µ—Å–ª–∏ —è —É–∂–µ –µ—Å—Ç—å –≤ –∏–≥—Ä–µ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
      if (data.you) joinCard.style.display = 'none';
    }

    document.getElementById('joinBtn').addEventListener('click', async () => {
      if (!code) { alert('–ù–µ—Ç –∫–æ–¥–∞ –∏–≥—Ä—ã –≤ URL'); return; }
      const name = document.getElementById('name').value.trim();
      const avatar = document.getElementById('avatar').value;
      const tgId = me || prompt('–í–∞—à Telegram id (–≤ –æ—Ç–ª–∞–¥–∫–µ –≤–Ω–µ Telegram):', '12345');
      if (!name || !tgId) return;

      const r = await fetch('/api/lobby/join', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ code, tgId, name, avatar })
      });
      const data = await r.json();
      if (!data.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ –ª–æ–±–±–∏'); return; }
      await loadState();
    });

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –ì–ú
    gmCard.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const act = btn.getAttribute('data-act'); // "hp:+1" / "gold:-1"
      const [field, deltaStr] = act.split(':');
      const delta = parseInt(deltaStr.replace('+',''), 10) * (deltaStr.startsWith('-') ? -1 : 1);
      const playerId = gmPlayerSelect.value;
      if (!playerId) return;

      const body = { code, me, playerId, delta };
      const url = field === 'gold' ? '/api/gm/grant-gold' : '/api/gm/grant-hp';
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const resp = await r.json();
      if (!resp.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ'); return; }
      await loadState();
    });

    loadState();
    setInterval(loadState, 3000);
  </script>
</body>
</html>
